// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  userId       Int      @id @default(autoincrement()) @map("user_id")
  email        String   @unique
  passwordHash String   @map("password_hash")
  firstName    String   @map("first_name")
  lastName     String?  @map("last_name")
  role         Role     @default(user)
  isActive     Boolean  @default(true) @map("is_active")
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  // Campi per la localizzazione
  preferredLatitude  Float?   @map("home_latitude")
  preferredLongitude Float?   @map("home_longitude")
  preferredAddress   String?  @map("home_address")

  chatbotResponses      ChatbotResponse[]
  datasetModifications DatasetModification[]

  @@index([email])
  @@index([role])
  @@map("user")
}

enum Role {
  user
  admin
  super_admin
}

model Category {
  categoryId  Int      @id @default(autoincrement()) @map("category_id")
  name        String   @unique
  description String?
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  geoDatasets GeoDataset[]

  @@index([name])
  @@map("category")
}

model GeoDataset {
  datasetId    Int      @id @default(autoincrement()) @map("dataset_id")
  name        String   @unique                                   // es: "Enti Messina"
  description String?
  // Path folder and file
  geojsonFile String   @unique @map("geojson_file")            // es: "Enti_Messina"
  iconFile    String   @default("icon.png") @map("icon_file")
  location    String?
  categoryId  Int      @map("category_id")
  // Versioning
  version        Int      @default(1)
  versionComment String?  @map("version_comment")     // "Aggiornato confini amministrativi"
  // State
  isActive   Boolean  @default(true) @map("is_active")
  isArchived Boolean  @default(false) @map("is_archived")
  // Time
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  category           Category            @relation(fields: [categoryId], references: [categoryId], onDelete: Restrict)
  datasetModifications DatasetModification[]

  @@index([categoryId])
  @@index([isActive, isArchived])
  @@map("geo_dataset")
}

model DatasetModification {
  modificationId Int      @id @default(autoincrement()) @map("modification_id")
  userId         Int?      @map("user_id")
  datasetId        Int      @map("dataset_id")
  actionType     String   @map("action_type")          // 'created', 'updated', 'file_replaced', 'archived', 'restored'
  // Snapshot versioning
  versionBefore  Int?     @map("version_before")
  versionAfter   Int?     @map("version_after")
  comment        String?                               // description of the snapshot
  createdAt DateTime @default(now()) @map("created_at")

  user           User?    @relation(fields: [userId], references: [userId], onDelete: SetNull) 
  dataset GeoDataset @relation(fields: [datasetId], references: [datasetId], onDelete: Restrict)

  @@index([userId])
  @@index([datasetId])
  @@index([createdAt(sort: Desc)])
  @@map("dataset_modification")
}

model ChatbotResponse {
  responseId Int      @id @default(autoincrement()) @map("response_id")
  userId         Int      @map("user_id")
  query          String
  answer         String
  geojsonData    Json     @map("geojson_data")
  createdAt      DateTime @default(now()) @map("created_at")

  user User @relation(fields: [userId], references: [userId], onDelete: Cascade)

  @@index([userId])
  @@index([createdAt(sort: Desc)])
  @@map("chatbot_response")
}